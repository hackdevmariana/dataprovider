<?php

namespace App\Filament\Resources;

use App\Filament\Resources\EnergyServiceResource\Pages;
use App\Filament\Resources\EnergyServiceResource\RelationManagers;
use App\Models\EnergyService;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\SoftDeletingScope;

class EnergyServiceResource extends Resource
{
    protected static ?string $model = EnergyService::class;

    protected static ?string $navigationIcon = 'fas-plug';

    protected static ?string $navigationGroup = 'Energ√≠a y Precios';

    protected static ?string $navigationLabel = 'Servicios Energ√©ticos';

    protected static ?int $navigationSort = 2;

    protected static ?string $modelLabel = 'Servicio Energ√©tico';

    protected static ?string $pluralModelLabel = 'Servicios Energ√©ticos';

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                Forms\Components\Section::make('Informaci√≥n B√°sica')
                    ->schema([
                        Forms\Components\TextInput::make('name')
                            ->required()
                            ->maxLength(255)
                            ->label('Nombre del Servicio')
                            ->placeholder('Nombre del servicio energ√©tico...'),
                        
                        Forms\Components\TextInput::make('service_code')
                            ->maxLength(100)
                            ->label('C√≥digo de Servicio')
                            ->placeholder('C√≥digo √∫nico del servicio...'),
                        
                        Forms\Components\Textarea::make('description')
                            ->required()
                            ->maxLength(1000)
                            ->label('Descripci√≥n')
                            ->rows(3)
                            ->placeholder('Descripci√≥n detallada del servicio...'),
                        
                        Forms\Components\Select::make('service_type')
                            ->options([
                                'electricity' => '‚ö° Electricidad',
                                'gas' => 'üî• Gas Natural',
                                'lpg' => 'üõ¢Ô∏è Gas Licuado',
                                'oil' => 'üõ¢Ô∏è Petr√≥leo',
                                'coal' => '‚õèÔ∏è Carb√≥n',
                                'biomass' => 'üå± Biomasa',
                                'solar' => '‚òÄÔ∏è Solar',
                                'wind' => 'üí® E√≥lico',
                                'hydro' => 'üíß Hidroel√©ctrico',
                                'nuclear' => '‚ò¢Ô∏è Nuclear',
                                'geothermal' => 'üåã Geot√©rmico',
                                'hydrogen' => '‚öóÔ∏è Hidr√≥geno',
                                'maintenance' => 'üîß Mantenimiento',
                                'consulting' => 'üíº Consultor√≠a',
                                'installation' => 'üîå Instalaci√≥n',
                                'other' => '‚ùì Otro',
                            ])
                            ->required()
                            ->label('Tipo de Servicio'),
                        
                        Forms\Components\Select::make('category')
                            ->options([
                                'generation' => '‚ö° Generaci√≥n',
                                'distribution' => 'üì° Distribuci√≥n',
                                'transmission' => 'üîå Transmisi√≥n',
                                'retail' => 'üè™ Comercializaci√≥n',
                                'maintenance' => 'üîß Mantenimiento',
                                'consulting' => 'üíº Consultor√≠a',
                                'installation' => 'üîå Instalaci√≥n',
                                'monitoring' => 'üìä Monitoreo',
                                'storage' => 'üîã Almacenamiento',
                                'efficiency' => 'üí° Eficiencia',
                                'renewable' => 'üå± Renovable',
                                'conventional' => 'üõ¢Ô∏è Convencional',
                                'hybrid' => 'üîÑ H√≠brido',
                                'other' => '‚ùì Otro',
                            ])
                            ->required()
                            ->label('Categor√≠a'),
                    ])->columns(2),

                Forms\Components\Section::make('Proveedor y Empresa')
                    ->schema([
                        Forms\Components\TextInput::make('provider_name')
                            ->required()
                            ->maxLength(255)
                            ->label('Nombre del Proveedor')
                            ->placeholder('Nombre de la empresa proveedora...'),
                        
                        Forms\Components\TextInput::make('provider_code')
                            ->maxLength(100)
                            ->label('C√≥digo del Proveedor')
                            ->placeholder('C√≥digo √∫nico del proveedor...'),
                        
                        Forms\Components\TextInput::make('company_registration')
                            ->maxLength(100)
                            ->label('Registro Mercantil')
                            ->placeholder('N√∫mero de registro...'),
                        
                        Forms\Components\TextInput::make('tax_id')
                            ->maxLength(100)
                            ->label('CIF/NIF')
                            ->placeholder('Identificaci√≥n fiscal...'),
                        
                        Forms\Components\TextInput::make('website')
                            ->maxLength(500)
                            ->label('Sitio Web')
                            ->url()
                            ->placeholder('https://www.ejemplo.com'),
                        
                        Forms\Components\TextInput::make('phone')
                            ->tel()
                            ->maxLength(50)
                            ->label('Tel√©fono'),
                    ])->columns(2),

                Forms\Components\Section::make('Caracter√≠sticas T√©cnicas')
                    ->schema([
                        Forms\Components\TextInput::make('capacity')
                            ->numeric()
                            ->step(0.01)
                            ->suffix('MW')
                            ->label('Capacidad')
                            ->helperText('Capacidad en megavatios'),
                        
                        Forms\Components\Select::make('capacity_unit')
                            ->options([
                                'MW' => 'MW (Megavatio)',
                                'kW' => 'kW (Kilovatio)',
                                'W' => 'W (Vatio)',
                                'MWh' => 'MWh (Megavatio-hora)',
                                'kWh' => 'kWh (Kilovatio-hora)',
                                'Wh' => 'Wh (Vatio-hora)',
                                'm¬≥/h' => 'm¬≥/h (Metros c√∫bicos por hora)',
                                'l/h' => 'l/h (Litros por hora)',
                                'kg/h' => 'kg/h (Kilogramos por hora)',
                                'other' => 'Otro',
                            ])
                            ->label('Unidad de Capacidad'),
                        
                        Forms\Components\TextInput::make('efficiency')
                            ->numeric()
                            ->step(0.01)
                            ->minValue(0)
                            ->maxValue(100)
                            ->suffix('%')
                            ->label('Eficiencia')
                            ->helperText('Porcentaje de eficiencia'),
                        
                        Forms\Components\TextInput::make('voltage')
                            ->numeric()
                            ->suffix('V')
                            ->label('Voltaje')
                            ->helperText('Voltaje en voltios'),
                        
                        Forms\Components\TextInput::make('frequency')
                            ->numeric()
                            ->suffix('Hz')
                            ->label('Frecuencia')
                            ->helperText('Frecuencia en hercios'),
                        
                        Forms\Components\TextInput::make('power_factor')
                            ->numeric()
                            ->step(0.01)
                            ->minValue(0)
                            ->maxValue(1)
                            ->label('Factor de Potencia')
                            ->helperText('Valor entre 0 y 1'),
                    ])->columns(2),

                Forms\Components\Section::make('Ubicaci√≥n y Cobertura')
                    ->schema([
                        Forms\Components\TextInput::make('location')
                            ->maxLength(255)
                            ->label('Ubicaci√≥n')
                            ->placeholder('Ciudad, regi√≥n o lugar espec√≠fico...'),
                        
                        Forms\Components\TextInput::make('country')
                            ->maxLength(100)
                            ->label('Pa√≠s')
                            ->placeholder('Pa√≠s donde se ofrece el servicio...'),
                        
                        Forms\Components\TextInput::make('region')
                            ->maxLength(100)
                            ->label('Regi√≥n')
                            ->placeholder('Regi√≥n, provincia o estado...'),
                        
                        Forms\Components\TextInput::make('postal_code')
                            ->maxLength(20)
                            ->label('C√≥digo Postal'),
                        
                        Forms\Components\TextInput::make('coordinates')
                            ->maxLength(100)
                            ->label('Coordenadas')
                            ->placeholder('Latitud, Longitud...'),
                        
                        Forms\Components\Select::make('coverage_area')
                            ->options([
                                'local' => 'üè† Local',
                                'regional' => 'üèòÔ∏è Regional',
                                'national' => 'üè≥Ô∏è Nacional',
                                'continental' => 'üåé Continental',
                                'global' => 'üåç Global',
                            ])
                            ->label('√Årea de Cobertura'),
                    ])->columns(2),

                Forms\Components\Section::make('Precios y Tarifas')
                    ->schema([
                        Forms\Components\TextInput::make('base_price')
                            ->numeric()
                            ->step(0.01)
                            ->prefix('‚Ç¨')
                            ->label('Precio Base')
                            ->helperText('Precio base del servicio'),
                        
                        Forms\Components\Select::make('price_unit')
                            ->options([
                                '‚Ç¨/kWh' => '‚Ç¨/kWh (Euro por kilovatio-hora)',
                                '‚Ç¨/MWh' => '‚Ç¨/MWh (Euro por megavatio-hora)',
                                '‚Ç¨/m¬≥' => '‚Ç¨/m¬≥ (Euro por metro c√∫bico)',
                                '‚Ç¨/l' => '‚Ç¨/l (Euro por litro)',
                                '‚Ç¨/kg' => '‚Ç¨/kg (Euro por kilogramo)',
                                '‚Ç¨/hora' => '‚Ç¨/hora (Euro por hora)',
                                '‚Ç¨/mes' => '‚Ç¨/mes (Euro por mes)',
                                '‚Ç¨/a√±o' => '‚Ç¨/a√±o (Euro por a√±o)',
                                '‚Ç¨/servicio' => '‚Ç¨/servicio (Euro por servicio)',
                                'other' => 'Otro',
                            ])
                            ->label('Unidad de Precio'),
                        
                        Forms\Components\Toggle::make('has_fixed_price')
                            ->label('Precio Fijo')
                            ->default(false),
                        
                        Forms\Components\Toggle::make('has_variable_price')
                            ->label('Precio Variable')
                            ->default(false),
                        
                        Forms\Components\TextInput::make('price_variability')
                            ->maxLength(100)
                            ->label('Variabilidad del Precio')
                            ->placeholder('Horaria, estacional, por demanda...'),
                        
                        Forms\Components\KeyValue::make('price_tiers')
                            ->label('Niveles de Precio')
                            ->keyLabel('Nivel')
                            ->valueLabel('Precio')
                            ->addActionLabel('Agregar Nivel'),
                    ])->columns(2),

                Forms\Components\Section::make('Disponibilidad y Horarios')
                    ->schema([
                        Forms\Components\Toggle::make('is_available_24_7')
                            ->label('Disponible 24/7')
                            ->default(false),
                        
                        Forms\Components\TextInput::make('business_hours')
                            ->maxLength(255)
                            ->label('Horario Comercial')
                            ->placeholder('L-V 9:00-18:00, S 9:00-14:00...'),
                        
                        Forms\Components\TextInput::make('response_time')
                            ->maxLength(100)
                            ->label('Tiempo de Respuesta')
                            ->placeholder('2 horas, 24 horas, inmediato...'),
                        
                        Forms\Components\Select::make('availability_status')
                            ->options([
                                'available' => 'üü¢ Disponible',
                                'limited' => 'üü° Limitado',
                                'unavailable' => 'üî¥ No Disponible',
                                'maintenance' => 'üîß En Mantenimiento',
                                'planned_outage' => 'üìÖ Corte Programado',
                                'emergency_outage' => 'üö® Corte de Emergencia',
                            ])
                            ->default('available')
                            ->label('Estado de Disponibilidad'),
                    ])->columns(2),

                Forms\Components\Section::make('Certificaciones y Calidad')
                    ->schema([
                        Forms\Components\Toggle::make('is_certified')
                            ->label('Certificado')
                            ->default(false),
                        
                        Forms\Components\TextInput::make('certification_body')
                            ->maxLength(255)
                            ->label('Organismo Certificador')
                            ->placeholder('Nombre del organismo...'),
                        
                        Forms\Components\TextInput::make('certification_number')
                            ->maxLength(100)
                            ->label('N√∫mero de Certificaci√≥n')
                            ->placeholder('N√∫mero de certificado...'),
                        
                        Forms\Components\DatePicker::make('certification_date')
                            ->label('Fecha de Certificaci√≥n')
                            ->displayFormat('d/m/Y'),
                        
                        Forms\Components\DatePicker::make('certification_expiry')
                            ->label('Vencimiento de Certificaci√≥n')
                            ->displayFormat('d/m/Y'),
                        
                        Forms\Components\Select::make('quality_rating')
                            ->options([
                                'excellent' => 'üü¢ Excelente (5/5)',
                                'very_good' => 'üü¢ Muy Bueno (4/5)',
                                'good' => 'üü° Bueno (3/5)',
                                'fair' => 'üü† Regular (2/5)',
                                'poor' => 'üî¥ Pobre (1/5)',
                                'not_rated' => '‚ö´ No Evaluado',
                            ])
                            ->label('Calificaci√≥n de Calidad'),
                    ])->columns(2),

                Forms\Components\Section::make('Informaci√≥n Adicional')
                    ->schema([
                        Forms\Components\KeyValue::make('additional_features')
                            ->label('Caracter√≠sticas Adicionales')
                            ->keyLabel('Caracter√≠stica')
                            ->valueLabel('Descripci√≥n')
                            ->addActionLabel('Agregar Caracter√≠stica'),
                        
                        Forms\Components\Textarea::make('notes')
                            ->maxLength(1000)
                            ->label('Notas')
                            ->rows(3)
                            ->placeholder('Notas adicionales o comentarios...'),
                        
                        Forms\Components\KeyValue::make('metadata')
                            ->label('Metadatos')
                            ->keyLabel('Campo')
                            ->valueLabel('Valor')
                            ->addActionLabel('Agregar Campo'),
                    ])->columns(1),

                Forms\Components\Section::make('Estado del Servicio')
                    ->schema([
                        Forms\Components\Toggle::make('is_active')
                            ->label('Activo')
                            ->default(true)
                            ->helperText('Indica si el servicio est√° activo'),
                        
                        Forms\Components\Toggle::make('is_featured')
                            ->label('Destacado')
                            ->default(false)
                            ->helperText('Servicio importante para destacar'),
                        
                        Forms\Components\Toggle::make('is_premium')
                            ->label('Premium')
                            ->default(false)
                            ->helperText('Servicio de alta calidad'),
                        
                        Forms\Components\Select::make('status')
                            ->options([
                                'active' => '‚úÖ Activo',
                                'inactive' => '‚ùå Inactivo',
                                'maintenance' => 'üîß En Mantenimiento',
                                'discontinued' => 'üö´ Discontinuado',
                                'beta' => 'üß™ Beta',
                                'deprecated' => '‚ö†Ô∏è Deprecado',
                            ])
                            ->default('active')
                            ->label('Estado'),
                    ])->columns(2),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('id')
                    ->label('ID')
                    ->sortable()
                    ->searchable(),
                
                Tables\Columns\TextColumn::make('name')
                    ->label('Servicio')
                    ->searchable()
                    ->limit(40)
                    ->weight('bold')
                    ->wrap(),
                
                Tables\Columns\BadgeColumn::make('service_type')
                    ->label('Tipo')
                    ->colors([
                        'warning' => 'electricity',
                        'info' => 'gas',
                        'success' => 'solar',
                        'primary' => 'wind',
                        'danger' => 'nuclear',
                        'secondary' => 'maintenance',
                    ])
                    ->formatStateUsing(fn (string $state): string => match ($state) {
                        'electricity' => '‚ö° Electricidad',
                        'gas' => 'üî• Gas Natural',
                        'lpg' => 'üõ¢Ô∏è Gas Licuado',
                        'oil' => 'üõ¢Ô∏è Petr√≥leo',
                        'coal' => '‚õèÔ∏è Carb√≥n',
                        'biomass' => 'üå± Biomasa',
                        'solar' => '‚òÄÔ∏è Solar',
                        'wind' => 'üí® E√≥lico',
                        'hydro' => 'üíß Hidroel√©ctrico',
                        'nuclear' => '‚ò¢Ô∏è Nuclear',
                        'geothermal' => 'üåã Geot√©rmico',
                        'hydrogen' => '‚öóÔ∏è Hidr√≥geno',
                        'maintenance' => 'üîß Mantenimiento',
                        'consulting' => 'üíº Consultor√≠a',
                        'installation' => 'üîå Instalaci√≥n',
                        'other' => '‚ùì Otro',
                        default => $state,
                    }),
                
                Tables\Columns\BadgeColumn::make('category')
                    ->label('Categor√≠a')
                    ->colors([
                        'primary' => 'generation',
                        'success' => 'distribution',
                        'warning' => 'transmission',
                        'info' => 'retail',
                        'danger' => 'maintenance',
                        'secondary' => 'consulting',
                    ])
                    ->formatStateUsing(fn (string $state): string => match ($state) {
                        'generation' => '‚ö° Generaci√≥n',
                        'distribution' => 'üì° Distribuci√≥n',
                        'transmission' => 'üîå Transmisi√≥n',
                        'retail' => 'üè™ Comercializaci√≥n',
                        'maintenance' => 'üîß Mantenimiento',
                        'consulting' => 'üíº Consultor√≠a',
                        'installation' => 'üîå Instalaci√≥n',
                        'monitoring' => 'üìä Monitoreo',
                        'storage' => 'üîã Almacenamiento',
                        'efficiency' => 'üí° Eficiencia',
                        'renewable' => 'üå± Renovable',
                        'conventional' => 'üõ¢Ô∏è Convencional',
                        'hybrid' => 'üîÑ H√≠brido',
                        'other' => '‚ùì Otro',
                        default => $state,
                    }),
                
                Tables\Columns\TextColumn::make('provider_name')
                    ->label('Proveedor')
                    ->searchable()
                    ->limit(25),
                
                Tables\Columns\TextColumn::make('location')
                    ->label('Ubicaci√≥n')
                    ->searchable()
                    ->limit(20),
                
                Tables\Columns\TextColumn::make('capacity')
                    ->label('Capacidad')
                    ->numeric()
                    ->suffix(fn ($record): string => $record->capacity_unit ?? 'MW')
                    ->sortable(),
                
                Tables\Columns\TextColumn::make('efficiency')
                    ->label('Eficiencia')
                    ->numeric()
                    ->suffix('%')
                    ->sortable()
                    ->color(fn (float $state): string => match (true) {
                        $state >= 90 => 'success',
                        $state >= 80 => 'info',
                        $state >= 70 => 'warning',
                        $state >= 60 => 'danger',
                        default => 'secondary',
                    }),
                
                Tables\Columns\TextColumn::make('base_price')
                    ->label('Precio Base')
                    ->money('EUR')
                    ->suffix(fn ($record): string => '/' . ($record->price_unit ?? 'kWh'))
                    ->sortable()
                    ->color(fn (float $state): string => match (true) {
                        $state < 0.10 => 'success',
                        $state < 0.20 => 'info',
                        $state < 0.50 => 'warning',
                        $state < 1.00 => 'danger',
                        default => 'dark',
                    }),
                
                Tables\Columns\BadgeColumn::make('availability_status')
                    ->label('Disponibilidad')
                    ->colors([
                        'success' => 'available',
                        'warning' => 'limited',
                        'danger' => 'unavailable',
                        'info' => 'maintenance',
                        'secondary' => 'planned_outage',
                        'dark' => 'emergency_outage',
                    ])
                    ->formatStateUsing(fn (string $state): string => match ($state) {
                        'available' => 'üü¢ Disponible',
                        'limited' => 'üü° Limitado',
                        'unavailable' => 'üî¥ No Disponible',
                        'maintenance' => 'üîß Mantenimiento',
                        'planned_outage' => 'üìÖ Corte Programado',
                        'emergency_outage' => 'üö® Corte Emergencia',
                        default => $state,
                    }),
                
                Tables\Columns\IconColumn::make('is_certified')
                    ->label('Certificado')
                    ->boolean()
                    ->trueColor('success')
                    ->falseColor('secondary'),
                
                Tables\Columns\IconColumn::make('is_active')
                    ->label('Activo')
                    ->boolean()
                    ->trueColor('success')
                    ->falseColor('danger'),
                
                Tables\Columns\IconColumn::make('is_featured')
                    ->label('Destacado')
                    ->boolean()
                    ->trueColor('warning')
                    ->falseColor('secondary'),
                
                Tables\Columns\IconColumn::make('is_premium')
                    ->label('Premium')
                    ->boolean()
                    ->trueColor('primary')
                    ->falseColor('secondary'),
                
                Tables\Columns\BadgeColumn::make('status')
                    ->label('Estado')
                    ->colors([
                        'success' => 'active',
                        'danger' => 'inactive',
                        'warning' => 'maintenance',
                        'secondary' => 'discontinued',
                        'info' => 'beta',
                        'dark' => 'deprecated',
                    ])
                    ->formatStateUsing(fn (string $state): string => match ($state) {
                        'active' => '‚úÖ Activo',
                        'inactive' => '‚ùå Inactivo',
                        'maintenance' => 'üîß Mantenimiento',
                        'discontinued' => 'üö´ Discontinuado',
                        'beta' => 'üß™ Beta',
                        'deprecated' => '‚ö†Ô∏è Deprecado',
                        default => $state,
                    }),
                
                Tables\Columns\TextColumn::make('created_at')
                    ->label('Creado')
                    ->dateTime('d/m/Y H:i')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->filters([
                Tables\Filters\SelectFilter::make('service_type')
                    ->options([
                        'electricity' => '‚ö° Electricidad',
                        'gas' => 'üî• Gas Natural',
                        'lpg' => 'üõ¢Ô∏è Gas Licuado',
                        'oil' => 'üõ¢Ô∏è Petr√≥leo',
                        'coal' => '‚õèÔ∏è Carb√≥n',
                        'biomass' => 'üå± Biomasa',
                        'solar' => '‚òÄÔ∏è Solar',
                        'wind' => 'üí® E√≥lico',
                        'hydro' => 'üíß Hidroel√©ctrico',
                        'nuclear' => '‚ò¢Ô∏è Nuclear',
                        'geothermal' => 'üåã Geot√©rmico',
                        'hydrogen' => '‚öóÔ∏è Hidr√≥geno',
                        'maintenance' => 'üîß Mantenimiento',
                        'consulting' => 'üíº Consultor√≠a',
                        'installation' => 'üîå Instalaci√≥n',
                        'other' => '‚ùì Otro',
                    ])
                    ->label('Tipo de Servicio'),
                
                Tables\Filters\SelectFilter::make('category')
                    ->options([
                        'generation' => '‚ö° Generaci√≥n',
                        'distribution' => 'üì° Distribuci√≥n',
                        'transmission' => 'üîå Transmisi√≥n',
                        'retail' => 'üè™ Comercializaci√≥n',
                        'maintenance' => 'üîß Mantenimiento',
                        'consulting' => 'üíº Consultor√≠a',
                        'installation' => 'üîå Instalaci√≥n',
                        'monitoring' => 'üìä Monitoreo',
                        'storage' => 'üîã Almacenamiento',
                        'efficiency' => 'üí° Eficiencia',
                        'renewable' => 'üå± Renovable',
                        'conventional' => 'üõ¢Ô∏è Convencional',
                        'hybrid' => 'üîÑ H√≠brido',
                        'other' => '‚ùì Otro',
                    ])
                    ->label('Categor√≠a'),
                
                Tables\Filters\SelectFilter::make('availability_status')
                    ->options([
                        'available' => 'üü¢ Disponible',
                        'limited' => 'üü° Limitado',
                        'unavailable' => 'üî¥ No Disponible',
                        'maintenance' => 'üîß En Mantenimiento',
                        'planned_outage' => 'üìÖ Corte Programado',
                        'emergency_outage' => 'üö® Corte de Emergencia',
                    ])
                    ->label('Estado de Disponibilidad'),
                
                Tables\Filters\SelectFilter::make('status')
                    ->options([
                        'active' => '‚úÖ Activo',
                        'inactive' => '‚ùå Inactivo',
                        'maintenance' => 'üîß En Mantenimiento',
                        'discontinued' => 'üö´ Discontinuado',
                        'beta' => 'üß™ Beta',
                        'deprecated' => '‚ö†Ô∏è Deprecado',
                    ])
                    ->label('Estado'),
                
                Tables\Filters\Filter::make('active_only')
                    ->label('Solo Activos')
                    ->query(fn (Builder $query): Builder => $query->where('is_active', true)),
                
                Tables\Filters\Filter::make('certified_only')
                    ->label('Solo Certificados')
                    ->query(fn (Builder $query): Builder => $query->where('is_certified', true)),
                
                Tables\Filters\Filter::make('featured_only')
                    ->label('Solo Destacados')
                    ->query(fn (Builder $query): Builder => $query->where('is_featured', true)),
                
                Tables\Filters\Filter::make('premium_only')
                    ->label('Solo Premium')
                    ->query(fn (Builder $query): Builder => $query->where('is_premium', true)),
                
                Tables\Filters\Filter::make('high_efficiency')
                    ->label('Alta Eficiencia')
                    ->query(fn (Builder $query): Builder => $query->where('efficiency', '>=', 90)),
                
                Tables\Filters\Filter::make('low_price')
                    ->label('Precios Bajos')
                    ->query(fn (Builder $query): Builder => $query->where('base_price', '<=', 0.20)),
                
                Tables\Filters\Filter::make('renewable_energy')
                    ->label('Energ√≠a Renovable')
                    ->query(fn (Builder $query): Builder => $query->whereIn('service_type', ['solar', 'wind', 'hydro', 'biomass', 'geothermal'])),
            ])
            ->actions([
                Tables\Actions\ViewAction::make()
                    ->label('Ver')
                    ->icon('fas-eye')
                    ->color('info'),
                
                Tables\Actions\EditAction::make()
                    ->label('Editar')
                    ->icon('fas-edit')
                    ->color('warning'),
                
                Tables\Actions\Action::make('toggle_featured')
                    ->label(fn ($record): string => $record->is_featured ? 'Quitar Destacado' : 'Destacar')
                    ->icon(fn ($record): string => $record->is_featured ? 'fas-star' : 'far-star')
                    ->action(function ($record): void {
                        $record->update(['is_featured' => !$record->is_featured]);
                    })
                    ->color(fn ($record): string => $record->is_featured ? 'warning' : 'success'),
                
                Tables\Actions\Action::make('toggle_premium')
                    ->label(fn ($record): string => $record->is_premium ? 'Quitar Premium' : 'Marcar Premium')
                    ->icon(fn ($record): string => $record->is_premium ? 'fas-crown' : 'far-crown')
                    ->action(function ($record): void {
                        $record->update(['is_premium' => !$record->is_premium]);
                    })
                    ->color(fn ($record): string => $record->is_premium ? 'primary' : 'secondary'),
                
                Tables\Actions\Action::make('visit_website')
                    ->label('Visitar Web')
                    ->icon('fas-external-link-alt')
                    ->url(fn ($record): string => $record->website)
                    ->openUrlInNewTab()
                    ->visible(fn ($record): bool => !empty($record->website))
                    ->color('primary'),
                
                Tables\Actions\Action::make('contact_provider')
                    ->label('Contactar')
                    ->icon('fas-phone')
                    ->url(fn ($record): string => "tel:{$record->phone}")
                    ->visible(fn ($record): bool => !empty($record->phone))
                    ->color('success'),
            ])
            ->bulkActions([
                Tables\Actions\BulkActionGroup::make([
                    Tables\Actions\DeleteBulkAction::make()
                        ->label('Eliminar')
                        ->icon('fas-trash')
                        ->color('danger')
                        ->requiresConfirmation(),
                    
                    Tables\Actions\BulkAction::make('activate')
                        ->label('Activar')
                        ->icon('fas-check')
                        ->action(function ($records): void {
                            $records->each->update(['is_active' => true]);
                        })
                        ->color('success'),
                    
                    Tables\Actions\BulkAction::make('deactivate')
                        ->label('Desactivar')
                        ->icon('fas-times')
                        ->action(function ($records): void {
                            $records->each->update(['is_active' => false]);
                        })
                        ->color('danger'),
                    
                    Tables\Actions\BulkAction::make('mark_featured')
                        ->label('Marcar como Destacados')
                        ->icon('fas-star')
                        ->action(function ($records): void {
                            $records->each->update(['is_featured' => true]);
                        })
                        ->color('warning'),
                    
                    Tables\Actions\BulkAction::make('mark_premium')
                        ->label('Marcar como Premium')
                        ->icon('fas-crown')
                        ->action(function ($records): void {
                            $records->each->update(['is_premium' => true]);
                        })
                        ->color('primary'),
                ]),
            ])
            ->defaultSort('name', 'asc')
            ->paginated([25, 50, 100]);
    }

    public static function getRelations(): array
    {
        return [
            //
        ];
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListEnergyServices::route('/'),
            'create' => Pages\CreateEnergyService::route('/create'),
            'view' => Pages\ViewEnergyService::route('/{record}'),
            'edit' => Pages\EditEnergyService::route('/{record}/edit'),
        ];
    }

    public static function getEloquentQuery(): Builder
    {
        return parent::getEloquentQuery();
    }
}
